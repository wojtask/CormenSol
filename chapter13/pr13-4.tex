\problem{Drzepce, czyli drzewa ,,treaps''} %13-4

\subproblem %13-4(a)
Dla danego zbioru węzłów $x_1$, $x_2$, \dots, $x_n$ może istnieć wiele możliwych drzew wyszukiwań binarnych zbudowanych z~tych węzłów.
Jeśli $\attrib{x_i}{key}<\attrib{x_j}{key}$, to węzeł $x_i$ może znajdować się w~lewym poddrzewie węzła $x_j$ albo $x_j$ może znajdować się w~prawym poddrzewie $x_i$.
Powiązanie z~każdym węzłem priorytetów i~utrzymywanie na ich podstawie własności kopca typu min w~drzepcu sprawia, że niejednoznaczność ta znika -- węzeł o~niższym priorytecie zajmuje w~drzepcu wyższy poziom od węzła o~wyższym priorytecie.
A~zatem, jeśli dodatkowo $\attrib{x_i}{priority}<\attrib{x_j}{priority}$, to węzeł $x_i$ jest przodkiem $x_j$, a~w~przeciwnym przypadku -- odwrotnie.
Dla każdej pary węzłów z~danego zbioru istnieje jednoznacznie wyznaczone ich wzajemne rozmieszczenie w~drzepcu, dlatego istnieje dokładnie jeden drzepiec dla tego zbioru węzłów i~powiązanych z~nimi priorytetów.

\subproblem %13-4(b)
Niech $T$ będzie drzepcem zbudowanym z~węzłów $x_1$, $x_2$, \dots, $x_n$.
Załóżmy bez utraty ogólności, że priorytety węzłów w~$T$ zostały wybrane ze zbioru $P=\{1,2,\dots,n\}$ losowo i~niezależnie od każdego węzła.
Rozważamy więc pewną permutację $\pi$ zbioru $P$, która wyznacza priorytety dla ciągu węzłów drzepca $T$, tzn.\ dla $i=1$, 2, \dots, $n$, priorytetem $x_i$ jest $\pi(i)$.
Oczywiście każda z~$n!$ permutacji zbioru $P$ jest jednakowo prawdopodobna, co oznacza, że każda permutacja kluczy węzłów, wyznaczona przez ich rosnące priorytety, jest również jednakowo prawdopodobna.
Możemy zatem potraktować drzepiec $T$ jak drzewo wyszukiwań binarnych utworzone przez wstawienie do niego węzłów o~coraz większym priorytecie, czyli, kolejno $x_{\pi^{-1}(1)}$, $x_{\pi^{-1}(2)}$, \dots, $x_{\pi^{-1}(n)}$.
Drzewo $T$ jest zatem losowo skonstruowanym drzewem wyszukiwań binarnych, które, na podstawie analizy z~podrozdziału 12.4, ma wysokość $h=O(\lg n)$.
Wynik ten, wraz z~dolnym oszacowaniem na $h$ otrzymanym w~\refExercise{B.5-4}, daje nam oczekiwaną wysokość drzepca równą $\Theta(\lg n)$.

\subproblem %13-4(c)
Procedura \proc{Treap-Insert} wstawia nowy węzeł $z$ do drzepca $T$ tak, jakby $T$ było zwykłym drzewem wyszukiwań binarnych.
Jeśli priorytet nowego węzła jest mniejszy od priorytetu jego ojca, to mamy naruszoną własność kopca typu min i~procedura przystępuje do jej przywrócenia.
Wykonuje w~tym celu odpowiednie rotacje, przenosząc dzięki temu węzeł $z$ na wyższe poziomy drzepca aż do momentu, gdy $z$ osiągnie korzeń albo gdy własność kopca między $z$ i~\attrib{z}{p} jest już spełniona.
Gdy $z$ jest lewym synem \attrib{z}{p}, to na \attrib{z}{p} wykonywana jest prawa rotacja, natomiast gdy $z$ jest prawym synem \attrib{z}{p} -- lewa rotacja.

Operacja wstawiania węzła do drzepca została przedstawiona na poniższym pseudokodzie:
\begin{codebox}
\Procname{$\proc{Treap-Insert}(T,z)$}
\li	$\proc{Tree-Insert}(T,z)$ \label{li:treap-insert-tree-insert}
\li	\While $z\ne\attrib{T}{root}$ i~$\attrib{z}{priority}<\attribb{z}{p}{priority}$
\li		\Do \If $z=\attribb{z}{p}{left}$
\li				\Then $\proc{Right-Rotate}(\attrib{z}{p})$
\li				\Else $\proc{Left-Rotate}(\attrib{z}{p})$
				\End		
		\End
\end{codebox}

\subproblem %13-4(d)
Wywołanie z~linii~\ref{li:treap-insert-tree-insert} potrzebuje czasu proporcjonalnego do wysokości $h$ drzepca $T$, a~liczba rotacji wykonywanych w~trakcie działania pętli \kw{while} nigdy nie przekracza $h$.
A~zatem oczekiwany czas działania procedury \proc{Treap-Insert} wynosi $\Theta(h)$, co na mocy faktu wykazanego w~punkcie (b) jest równe $\Theta(\lg n)$.

\subproblem %13-4(e)
\subproblem %13-4(f)
\note{Definicja zmiennej losowej\/ $X_{i,k}$ powinna brzmieć następująco:}
\bignegskip
\[
	X_{i,k} = \I(\text{$y$ jest na prawym kręgosłupie lewego poddrzewa węzła $x$ (w~$T$)}).
\]
\smallskip

\noindent Wprowadźmy oznaczenia $T^L_x$ i~$T^R_x$ na, odpowiednio, lewe i~prawe poddrzewo węzła $x$.
Będziemy też pisać $x\in T$ dla oznaczenia, że $x$ jest węzłem w~drzewie $T$.

Koniunkcja warunków $\attrib{y}{priority}>\attrib{x}{priority}$ i~$\attrib{y}{key}<\attrib{x}{key}$ jest równoważna temu, że $y\in T^L_x$.
Zastanówmy się teraz, które węzły $z\in T$ spełniają nierówności $\attrib{y}{key}<\attrib{z}{key}<\attrib{x}{key}$.
Pierwsza z~nich jest prawdziwa wtedy, gdy $z\in T^R_y$ albo $y\in T^L_z$, a~druga, gdy $z\in T^L_x$ albo $x\in T^R_z$.
Przy założeniu, że $y\in T^L_x$, obydwie nierówności zachodzą w~następujących przypadkach:
\begin{enumerate}
	\renewcommand{\labelenumi}{(\roman{enumi})}
	\item $z\in T^L_x$ i~$y\in T^L_z$;
	\item $z\in T^R_y$.
\end{enumerate}
Przypadek (i) obejmuje węzły $z$ z~lewego poddrzewa $x$, które z~kolei w~swoim lewym poddrzewie mają $y$.
Zgodnie z~własnościami drzepca oznacza to, że $\attrib{x}{priority}<\attrib{z}{priority}<\attrib{y}{priority}$.
W~przypadku (ii) zaś zachodzi $\attrib{y}{priority}<\attrib{z}{priority}$.
Jeśli nie istnieje węzeł $z\in T$, który spełnia warunek (i), to $y$ znajduje się na prawym kręgosłupie drzewa $T^L_x$.
Podobnie w~drugą stronę, jeśli $y$ jest na prawym kręgosłupie $T^L_x$, to nie istnieje węzeł $z\in T^L_x$, dla którego $y\in T^L_z$.

\subproblem %13-4(g)
\subproblem %13-4(h)
W~lewym poddrzewie węzła $x$ o~kluczu $k=\attrib{x}{key}$ znajdują się węzły o~kluczach $j<k$, dlatego możemy napisać $C=\sum_{j=1}^{k-1}X_{j,k}$.
Stąd
\begin{align*}
	\E(C) &= \E\biggl(\sum_{j=1}^{k-1}X_{j,k}\biggr) = \sum_{j=1}^{k-1}\E(X_{j,k}) = \sum_{j=1}^{k-1}\Pr(X_{j,k}=1) \\
	&= \sum_{j=1}^{k-1}\frac{1}{(k-j+1)(k-j)} = \sum_{j=1}^{k-1}\frac{1}{j(j+1)} = \sum_{j=1}^{k-1}\biggl(\frac{1}{j}-\frac{1}{j+1}\biggr) = 1-\frac{1}{k}.
\end{align*}

\subproblem %13-4(i)
\subproblem %13-4(j)
Na podstawie wyników uzyskanych w~poprzednich punktach mamy, że oczekiwana liczba rotacji wykonywanych przez \proc{Treap-Insert} wynosi
\[
	\E(C+D) = \E(C)+\E(D) = 1-\frac{1}{k}+1-\frac{1}{n-k+1} < 2.
\]
