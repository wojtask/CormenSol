\problem{Drzewa AVL} %13-3

\subproblem %13-3(a)
Udowodnimy stwierdzenie ze wskazówki, wykorzystując indukcję po wysokościach drzew AVL.
Jako podstawę indukcji przyjmiemy drzewa AVL o~wysokościach 0 i~1.
W~drzewie o~wysokości 0 jest tylko jeden węzeł, czyli więcej niż $F_0=0$, zaś~drzewo o~wysokości 1 może składać się z~minimalnie 2 węzłów, co jest większe niż $F_1=1$.

Niech teraz dane będzie drzewo AVL o~wysokości $h\ge2$ i~niech $h_L$ będzie wysokością jego lewego poddrzewa, a~$h_R$ -- wysokością jego prawego poddrzewa.
Bez utraty ogólności możemy przyjąć, że $h_L\le h_R$, skąd $h=h_R+1$.
Na podstawie definicji drzewa AVL mamy, że $|h_R-h_L|\le1$, a~więc na mocy powyższego $h_L\ge h_R-1$.
Z~kolei z~założenia indukcyjnego mamy, że liczby węzłów $n_L$ i~$n_R$ w~lewym i~prawym poddrzewie wynoszą, odpowiednio, co najmniej $F_{h_L}$ i~co najmniej $F_{h_R}$.
Stąd liczba węzłów drzewa wynosi $n=n_L+n_R+1\ge F_{h_L}+F_{h_R}+1\ge F_{h_R-1}+F_{h_R}+1=F_{h_R+1}+1=F_h+1>F_h$.
Z~\refExercise{3.2-7} mamy $F_h\ge\phi^{h-2}$ dla każdego $h\ge2$, a~zatem $n>F_h\ge\phi^{h-2}$, skąd otrzymujemy ostatecznie $h<\log_\phi n+2=O(\lg n)$.

\subproblem %13-3(b)
Zanim podamy pseudokod algorytmu \proc{Balance}, zdefiniujemy pomocnicze procedury, które będą w~nim wykorzystywane.

Dla każdego węzła $x$ w~drzewie AVL definiujemy jego \textbf{współczynnik zrównoważenia} jako wartość zwracaną przez następującą procedurę:
\begin{codebox}
\Procname{$\proc{Balance-Factor}(x)$}
\li	$\id{hl}\gets\id{hr}\gets-1$
\li	\If $\attrib{x}{left}\ne\const{nil}$
\li		\Then $\id{hl}\gets\attribb{x}{left}{h}$
		\End
\li	\If $\attrib{x}{right}\ne\const{nil}$
\li		\Then $\id{hr}\gets\attribb{x}{right}{h}$
		\End
\li	\Return $-\id{hl}+\id{hr}$
\end{codebox}
W~drzewie zrównoważonym po wysokościach współczynnik zrównoważenia dowolnego jego węzła przyjmuje wartość $-1$, 0 lub 1.
Będziemy korzystać także z~procedury $\proc{Height}(x)$, która dla danego węzła $x$ zwróci jego aktualną wysokość w~drzewie na podstawie wartości pola $h$ jego synów.
Jej działanie jest identyczne z~$\proc{Balance-Factor}(x)$ z~wyjątkiem ostatniego wiersza, w~którym zwracana jest wartość $\max(\id{hl},\id{hr})+1$.

Opiszmy też procedury \proc{AVL-Left-Rotate} i~\proc{AVL-Right-Rotate}, których zadaniem jest wykonanie rotacji na węźle $x$ w~drzewie, które niekoniecznie jest zrównoważone po wysokościach.
Różnią się one od \proc{Left-Rotate} i~\proc{Right-Rotate} tym, że nie aktualizują wskaźnika \attrib{T}{root} w~wierszu 6, a~tuż przed zakończeniem działania aktualizują jeszcze \attrib{x}{h} i~\attrib{y}{h} na wartości, odpowiednio, $\proc{Height}(x)$ i~$\proc{Height}(y)$.

\begin{codebox}
\Procname{$\proc{Balance}(x)$}
\li	\If $\proc{Balance-Factor}(x)=-2$
\li		\Then \If $\proc{Balance-Factor}(\attrib{x}{left})=1$ \label{li:balance-left-cases-begin}
\li				\Then $\proc{AVL-Left-Rotate}(\attrib{x}{left})$ \label{li:balance-left-right-case}
				\End
\li				$\proc{AVL-Right-Rotate}(x)$ \label{li:balance-left-left-case}
\li				\Return \attrib{x}{p} \label{li:balance-left-cases-end}
\li		\Else \If $\proc{Balance-Factor}(x)=2$
\li				\Then (to samo co w~wierszach \doubledash{\ref{li:balance-left-cases-begin}}{\ref{li:balance-left-cases-end}} z~zamienionymi ,,right'' i~,,left'')
				\End
		\End
\li	\Return $x$
\end{codebox}
Procedura $\proc{Balance}(T,x)$ modyfikuje drzewo, gdy $|\proc{Balance-Factor}(x)|=2$, przy założeniu, że dla każdego potomka $y$ węzła $x$ zachodzi $|\proc{Balance-Factor}(y)|\le1$.
Rozważmy 4 przypadki w~zależności od współczynników zrównoważenia $x$ oraz jego synów.
W~przypadku, który określimy jako ,,lewo-lewo'', spełnione jest $\proc{Balance-Factor}(x)=-2$ oraz $\proc{Balance-Factor}(\attrib{x}{left})\in\{-1,0\}$.
Aby zrównoważyć $x$, wystarczy wykonać na nim prawą rotację.
Przypadek ,,lewo-prawo'' zachodzi wtedy, gdy $\proc{Balance-Factor}(x)=-2$ i~$\proc{Balance-Factor}(\attrib{x}{left})=1$.
Można go jednak sprowadzić do przypadku ,,lewo-lewo'', wykonując lewą rotację na \attrib{x}{left}.
Wynikiem zwracanym przez procedurę jest najwyższy węzeł biorący udział w~rotacjach w~danym wywołaniu, czyli taki, który zastąpił $x$ w~roli korzenia modyfikowanego poddrzewa, albo $x$, jeżeli drzewo nie było zmieniane.
Działanie procedury dla opisanych przypadków przedstawione zostało na rys.\ \ref{fig:13-3b}.
\begin{figure}[!ht]
	\centering \input{fig13-3b}
	\caption{Działanie procedury \proc{Balance} wywołanej dla węzła $x$, który nie jest zrównoważony po wysokościach.
	Obok węzłów $x$, $y$, $w$ i~poddrzew $\alpha$, $\beta$, $\gamma$, $\delta$ zaznaczone zostały ich wysokości.
	{\sffamily\bfseries(a)} Przypadek ,,lewo-lewo''.
	Jeśli przyjmiemy, że wysokością poddrzewa $\gamma$ jest $h$, to wysokość poddrzewa o~korzeniu w~$y$ wynosi $h+2$.
	Węzeł $y$ jest zrównoważony i~$\proc{Balance-Factor}(y)\in\{-1,0\}$, więc poddrzewo $\alpha$ ma wysokość $h+1$, a~poddrzewo $\beta$ może mieć wysokość równą $h$ lub $h+1$.
	Drzewo $T$ po lewej stronie rysunku zostaje przekształcone w~zrównoważone drzewo po prawej stronie rysunku po wykonaniu $\proc{AVL-Right-Rotate}(x)$.
	{\sffamily\bfseries(b)} W~przypadku ,,lewo-prawo'' po przyjęciu, że wysokością $\delta$ jest $h$, mamy, że wysokość poddrzewa o~korzeniu w~węźle $y$ wynosi $h+2$.
	Tutaj jednak $\proc{Balance-Factor}(y)=1$, więc wyróżniamy $w$ -- prawego syna $y$ o~wysokości $h+1$, którego oba poddrzewa, $\beta$ i~$\gamma$, mają wysokość $h-1$ lub $h$.
	Zrównoważenie drzewa $T$ odbywa się poprzez wywołanie najpierw $\proc{AVL-Left-Rotate}(y)$, a~następnie $\proc{AVL-Right-Rotate}(x)$.} \label{fig:13-3b}
\end{figure}

Pozostałe przypadki, ''prawo-prawo'' oraz ,,prawo-lewo'', są symetryczne do poprzednich, gdzie tym razem $\proc{Balance-Factor}(x)=2$.
Aby je obsłużyć, wystarczy w~wierszach \doubledash{\ref{li:balance-left-cases-begin}}{\ref{li:balance-left-cases-end}} zamienić lewych synów z~prawymi i~odwrócić kierunki rotacji.

\subproblem %13-3(c)
Idea działania operacji \proc{AVL-Insert} opiera się na procedurze \proc{Recursive-Tree-Insert} z~\refExercise{12.3-1}.
Po wstawieniu węzła $z$ do niepustego drzewa AVL o~korzeniu w~$x$, węzeł $x$ może mieć nieaktualną wartość w~polu $h$ i~zaburzoną równowagę po wysokościach.
Problemy te można naprawić, aktualizując \attrib{x}{h} wartością $\proc{Height}(x)$ oraz wywołując dla $x$ procedurę \proc{Balance} opisaną w~części (b).
Wynikiem zwracanym przez \proc{AVL-Insert} jest aktualny korzeń drzewa, do którego wstawiane było $z$.
Pseudokod tej operacji został przedstawiony poniżej:
\begin{codebox}
\Procname{$\proc{AVL-Insert}(x,z)$}
\li	\If $x=\const{nil}$
\li		\Then \Return $z$
		\End
\li	\If $\attrib{z}{key}<\attrib{x}{key}$
\li		\Then $\attrib{x}{left}\gets\proc{AVL-Insert}(\attrib{x}{left},z)$
\li			$\attribb{x}{left}{p}\gets x$
\li		\Else $\attrib{x}{right}\gets\proc{AVL-Insert}(\attrib{x}{right},z)$
\li			$\attribb{x}{right}{p}\gets x$
		\End
\li	$\attrib{x}{h}\gets\proc{Height}(x)$
\li	\Return $\proc{Balance}(x)$
\end{codebox}

Podobnie jak \proc{Recursive-Tree-Insert}, z~powyższej procedury nie należy korzystać bezpośrednio, ale poprzez wywołanie poniższego pseudokodu, który aktualizuje pole \id{root} drzewa $T$, do którego wstawiany jest węzeł $z$.
\begin{codebox}
\Procname{$\proc{AVL-Insert}'(T,z)$}
\li	$\attrib{T}{root}\gets\proc{AVL-Insert}(\attrib{T}{root},z)$
\end{codebox}

\subproblem %13-3(d)
\note{Ten punkt pyta o~coś, co nie jest prawdą.
Podamy więc rozwiązanie dla treści z~erraty do oryginału, której tłumaczenie brzmi:
}

\noindent Pokaż, że operacja \proc{AVL-Insert} dla drzewa AVL o~$n$ węzłach działa w~czasie $O(\lg n)$ i~wykonuje $O(1)$ rotacji.

\bigskip
\note{Rozwiązanie tego zadania znajduje się poniżej.}

\noindent Wszystkie operacje, które opisaliśmy w~punkcie (b), tzn.\ \proc{Balance-Factor}, \proc{Height}, operacje rotacji oraz \proc{Balance} działają w~czasie stałym.
Na każdym poziomie rekurencji procedura \proc{AVL-Insert} wykonuje więc $O(1)$ operacji.
Liczbę poziomów rekurencji można z~kolei ograniczyć od góry przez wysokość $h$ drzewa, na którym ona działa.
W~drzewie o~$n$ węzłach $h=O(\lg n)$, zatem czas działania \proc{AVL-Insert} dla drzewa o~$n$ węzłach wynosi $O(\lg n)$.

Na każdym poziomie rekursji w~\proc{AVL-Insert} wywoływana jest operacja \proc{Balance}.
Wykażemy jednak, że sumaryczna liczba rotacji w~niej przeprowadzanych jest nie większa niż 2.
Po znalezieniu miejsca w~drzewie dla węzła $z$ rekurencja wraca, wywołując \proc{Balance} dla przodków $z$ na coraz wyższych poziomach drzewa.
Rotacje zostaną wykonane w~\proc{Balance} tylko wówczas, gdy współczynnik zrównoważenia aktualnego przodka $z$ wynosi $-2$ lub 2.
Niech $x$ będzie pierwszym napotkanym węzłem o~tej własności, czyli najgłębiej położonym przodkiem węzła $z$, który nie jest zrównoważony po wysokościach.
Sprawdźmy, jak zmieni się wysokość poddrzewa o~korzeniu w~$x$ w~każdym z~przypadków rozważanych w~procedurze \proc{Balance}.

Posługując się oznaczeniami z~rys.\ \ref{fig:13-3b}, w~przypadku ,,lewo-lewo'' zanim nowy węzeł $z$ został umieszczony w~drzewie, węzeł $x$ znajdujący się na wysokości $h+2$ był zrównoważony po wysokościach, więc węzeł $y$ miał wysokość $h+1$, a~wysokość poddrzew $\alpha$ i~$\beta$ wynosiła $h$.
Nowy węzeł musiał więc zostać dodany do poddrzewa $\alpha$.
Po wykonaniu rotacji w~wierszu \ref{li:balance-left-left-case} procedury \proc{Balance} wysokość węzła $x$ wynosi $h+1$, skąd wysokością $y$ jest $h+2$.
Wywołanie procedury \proc{Balance} przywraca zatem nie tylko zrównoważenie poddrzewa, na którym ona działa, ale także przywraca wysokość tego poddrzewa do wartości sprzed wstawienia węzła $z$.
Dzięki temu zrównoważenie po wysokościach każdego przodka węzła $y$ pozostaje nienaruszone i~w~dalszym działaniu procedury \proc{AVL-Insert} nie zostanie wykonana już żadna rotacja.

Jeśli z~kolei wstawienie $z$ doprowadziło do przypadku ,,lewo-prawo'', to początkowo wysokość węzła $y$ wynosiła $h+1$, a~wysokość węzła $x$ wynosiła $h+2$.
Po wstawieniu $z$ do drzewa oraz wykonaniu rotacji w~liniach \ref{li:balance-left-right-case} i~\ref{li:balance-left-left-case} poddrzewo o~korzeniu w~$x$ zostaje przekształcone w~zrównoważone po wysokościach poddrzewo o~korzeniu w~$w$ o~wysokości $h+2$ równej tej sprzed przekształcenia.
Każdy przodek węzła $w$ pozostaje więc zrównoważony, dlatego rotacje nie będą już wykonywane.

Analiza w~przypadkach ,,prawo-lewo'' i ,,prawo-prawo'' jest analogiczna.
